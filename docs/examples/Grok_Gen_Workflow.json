{
    "format": "pedantic-workflow-v1",
    "metadata": {
      "name": "Silent Web Archiver + Smart Summary (Gap-Free Edition)",
      "description": "Stealth browser → HTML parse (w/ html mod) + OCR merge → LLM insight → Local save + views. 100% spec-compliant, zero gaps.",
      "tags": ["archive", "research", "local-llm", "stealth"],
      "exportedAt": "2025-12-01T00:00:00Z",
      "version": "1.3.0"
    },
    "workflow": {
      "nodes": {
        "start": { "type": "start", "title": "Start", "position": { "x": 100, "y": 300 } },
        
        "url_input": {
          "type": "python",
          "title": "Set URL (edit here!)",
          "code": "def run(input):\n    return {\"url\": \"https://news.ycombinator.com\"}",
          "position": { "x": 400, "y": 300 }
        },
        
        "browser": {
          "type": "browser",
          "title": "Stealth Fetch",
          "config": {
            "url": "{url}",
            "headless": true,
            "stealth_mode": true,
            "wait_for": "network_idle",
            "output_formats": ["html", "screenshot"],
            "timeout": 60000
          },
          "position": { "x": 700, "y": 300 }
        },
        
        "ocr": {
          "type": "ocr",
          "title": "OCR Backup Text",
          "config": { "content_key": "screenshot", "language": "eng", "psm": 6 },
          "position": { "x": 1000, "y": 500 }
        },
        
        "extract_text": {
          "type": "python",
          "title": "Parse HTML → Clean Text",
          "code": "import re\n    from html import unescape\n\ndef run(input):\n        html = input.get('html', '')\n        # Strip scripts/styles w/ regex\n        cleaned = re.sub(r'(?is)<(script|style|nav|header|footer).*?</\\1>', '', html)\n        # Extract title\n        title_match = re.search(r'<title[^>]*>(.*?)</title>', cleaned, re.I | re.S)\n        title = unescape(title_match.group(1).strip()) if title_match else 'Untitled Page'\n        # Brutal tag strip + unescape\n        text = re.sub(r'<[^>]+>', ' ', cleaned)\n        text = unescape(re.sub(r'\\s+', ' ', text).strip())\n        return {\n            **input,\n            \"title\": title,\n            \"html_text\": text[:10000]  # LLM-friendly truncate\n        }",
          "position": { "x": 1000, "y": 100 }
        },
        
        "merge_text": {
          "type": "python",
          "title": "Merge Sources → Best Text",
          "code": "def run(input):\n        html_text = input.get('html_text', '')\n        ocr_text = input.get('text', '')\n        best = html_text if len(html_text) > 600 else (ocr_text or html_text)\n        return {\n            **input,\n            \"best_text\": best\n        }",
          "position": { "x": 1300, "y": 300 }
        },
        
        "llm_summary": {
          "type": "llm",
          "title": "Generate Insights",
          "config": {
            "provider": "openrouter",
            "model": "anthropic/claude-3.5-sonnet",
            "temperature": 0.2,
            "max_tokens": 1000,
            "system": "You are a sharp researcher: concise, factual, punchy.",
            "user": "# {title}\n\n{best_text}\n\nOutput:\n- 3-sentence TL;DR\n- 5 key takeaways (bullets)\n- 3 top quotes\n- 1 quirky fact (or N/A)\nTotal <350 words.",
            "api_key_name": "OPENROUTER_API_KEY"
          },
          "position": { "x": 1600, "y": 300 }
        },
        
        "save_archive": {
          "type": "python",
          "title": "Archive to /tmp Files",
          "code": "import os, base64, datetime, re\n\ndef run(input):\n        ts = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')\n        safe_name = re.sub(r'[^a-zA-Z0-9_-]', '_', input.get('title', 'page'))[:50]\n        html_path = f\"/tmp/workflow_files/archive_{ts}_{safe_name}.html\"\n        img_path = f\"/tmp/workflow_files/screenshot_{ts}_{safe_name}.png\"\n        md_path = f\"/tmp/workflow_files/summary_{ts}_{safe_name}.md\"\n        \n        # Save HTML\n        with open(html_path, 'w', encoding='utf-8') as f:\n            f.write(input.get('html', ''))\n        \n        # Save screenshot if present\n        if input.get('screenshot'):\n            data_url = input['screenshot']\n            if data_url.startswith('data:image/'):\n                img_b64 = data_url.split(',')[1]\n                with open(img_path, 'wb') as f:\n                    f.write(base64.b64decode(img_b64))\n        \n        # Save summary\n        with open(md_path, 'w', encoding='utf-8') as f:\n            f.write(input.get('content', '# No summary generated'))\n        \n        return {\n            **input,\n            \"saved_paths\": {\n                \"html\": html_path,\n                \"screenshot\": img_path if input.get('screenshot') else None,\n                \"summary\": md_path\n            }\n        }",
          "position": { "x": 1900, "y": 300 }
        },
        
        "view_summary": {
          "type": "markdown",
          "title": "View Summary MD",
          "config": { "content_key": "content" },
          "position": { "x": 2200, "y": 200 }
        },
        
        "view_html": {
          "type": "html",
          "title": "View Original HTML",
          "config": { "content_key": "html" },
          "position": { "x": 2200, "y": 400 }
        },
        
        "end": { "type": "end", "title": "Archived!", "position": { "x": 2500, "y": 300 } }
      },
      "connections": {
        "c1": { "source": "start", "target": "url_input", "sourceOutput": "output", "targetInput": "input" },
        "c2": { "source": "url_input", "target": "browser", "sourceOutput": "output", "targetInput": "input" },
        "c3": { "source": "browser", "target": "ocr", "sourceOutput": "output", "targetInput": "input" },
        "c4": { "source": "browser", "target": "extract_text", "sourceOutput": "output", "targetInput": "input" },
        "c5": { "source": "ocr", "target": "merge_text", "sourceOutput": "output", "targetInput": "input" },
        "c6": { "source": "extract_text", "target": "merge_text", "sourceOutput": "output", "targetInput": "input" },
        "c7": { "source": "merge_text", "target": "llm_summary", "sourceOutput": "output", "targetInput": "input" },
        "c8": { "source": "llm_summary", "target": "save_archive", "sourceOutput": "output", "targetInput": "input" },
        "c9": { "source": "save_archive", "target": "view_summary", "sourceOutput": "output", "targetInput": "input" },
        "c10": { "source": "save_archive", "target": "view_html", "sourceOutput": "output", "targetInput": "input" },
        "c11": { "source": "view_summary", "target": "end", "sourceOutput": "output", "targetInput": "input" },
        "c12": { "source": "view_html", "target": "end", "sourceOutput": "output", "targetInput": "input" }
      },
      "metadata": {
        "nodeCount": 11,
        "lastModified": "2025-12-01T00:00:00Z"
      }
    }
  }